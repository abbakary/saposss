{% extends 'tracker/base.html' %}
{% load static %}
{% load date_filters %}
{% block title %}{{ title }}{% endblock %}

{% block content %}
<div class="page-body">
  <div class="container-fluid">
    <div class="page-title">
      <div class="row align-items-center">
        <div class="col-md-6"><h4>{{ title }}</h4></div>
        <div class="col-md-6">
          <ol class="breadcrumb justify-content-md-end mb-0">
            <li class="breadcrumb-item"><a href="{% url 'tracker:orders_list' %}">Orders</a></li>
            {% if order %}<li class="breadcrumb-item"><a href="{% url 'tracker:order_detail' order.id %}">Order #{{ order.order_number }}</a></li>{% endif %}
            <li class="breadcrumb-item active">{{ order|yesno:'Edit,New' }} Order</li>
          </ol>
        </div>
      </div>
    </div>
  </div>

  <div class="container-fluid">
    <div class="card shadow-sm">
      <div class="card-header bg-light"><h6 class="mb-0"><i class="fa fa-list me-2"></i>Order Details</h6></div>
      <div class="card-body">
        <form method="post" class="needs-validation" novalidate>
          {% csrf_token %}
          {% if form.non_field_errors %}
            <div class="alert alert-danger">{% for e in form.non_field_errors %}{{ e }}{% endfor %}</div>
          {% endif %}

          <div class="row g-3">
            <div class="col-lg-4">
              <label class="form-label" for="id_type">Order Type</label>
              {{ form.type }}
              <div class="invalid-feedback d-block">{{ form.type.errors|join:" " }}</div>
            </div>
            <div class="col-lg-4">
              <label class="form-label" for="id_priority">Priority</label>
              {{ form.priority }}
              <div class="invalid-feedback d-block">{{ form.priority.errors|join:" " }}</div>
            </div>
            <div class="col-lg-4">
              <label class="form-label" for="id_estimated_duration">Estimated Duration (minutes)</label>
              {{ form.estimated_duration }}
              <div class="invalid-feedback d-block">{{ form.estimated_duration.errors|join:" " }}</div>
            </div>

            <div class="col-lg-6">
              <label class="form-label" for="id_vehicle">Vehicle</label>
              {{ form.vehicle }}
              <div class="invalid-feedback d-block">{{ form.vehicle.errors|join:" " }}</div>
            </div>
            <div class="col-lg-6">
              <label class="form-label" for="id_description">Description</label>
              {{ form.description }}
              <div class="invalid-feedback d-block">{{ form.description.errors|join:" " }}</div>
            </div>
          </div>

          <hr class="my-4">

          <div id="salesFields" class="row g-3">
            <div class="col-lg-6">
              <label class="form-label" for="id_item_name">Item</label>
              {{ form.item_name }}
              <div class="invalid-feedback d-block">{{ form.item_name.errors|join:" " }}</div>
            </div>
            <div class="col-lg-3">
              <label class="form-label" for="id_quantity">Quantity</label>
              {{ form.quantity }}
              <div class="invalid-feedback d-block">{{ form.quantity.errors|join:" " }}</div>
            </div>
            <div class="col-lg-3">
              <label class="form-label">Brand</label>
              {{ form.brand }}
              <div id="brandDisplay" class="form-control bg-light" readonly></div>
            </div>
          </div>

          <div id="serviceFields" class="row g-3">
            <div class="col-12">
              <div class="small text-muted mb-2">Select services (optional)</div>
              <div class="row g-2">
                {% for v,label in form.SERVICE_OPTIONS %}
                  <div class="col-sm-6 col-md-4">
                    <label class="border rounded p-2 w-100 d-flex align-items-center gap-2">
                      <input type="checkbox" name="service_selection" value="{{ v }}" class="form-check-input" {% if form.data.service_selection and v in form.data.getlist('service_selection') %}checked{% endif %}>
                      <span>{{ label }}</span>
                    </label>
                  </div>
                {% endfor %}
              </div>
            </div>
          </div>

          <div id="inquiryFields" class="row g-3">
            <div class="col-lg-4">
              <label class="form-label" for="id_inquiry_type">Inquiry Type</label>
              {{ form.inquiry_type }}
              <div class="invalid-feedback d-block">{{ form.inquiry_type.errors|join:" " }}</div>
            </div>
            <div class="col-lg-4">
              <label class="form-label" for="id_contact_preference">Contact Preference</label>
              {{ form.contact_preference }}
              <div class="invalid-feedback d-block">{{ form.contact_preference.errors|join:" " }}</div>
            </div>
            <div class="col-lg-4">
              <label class="form-label" for="id_follow_up_date">Follow-up Date</label>
              {{ form.follow_up_date }}
              <div class="invalid-feedback d-block">{{ form.follow_up_date.errors|join:" " }}</div>
            </div>
            <div class="col-12">
              <label class="form-label" for="id_questions">Questions</label>
              {{ form.questions }}
              <div class="invalid-feedback d-block">{{ form.questions.errors|join:" " }}</div>
            </div>
          </div>

          <div class="mt-3 d-flex gap-2">
            <a class="btn btn-outline-secondary" href="{% if order %}{% url 'tracker:order_detail' order.id %}{% else %}{% url 'tracker:orders_list' %}{% endif %}"><i class="fa fa-arrow-left me-1"></i>Back</a>
            <button class="btn btn-primary" type="submit"><i class="fa fa-save me-1"></i>Save</button>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
(function(){
  function toggle(){
    var t = document.getElementById('id_type');
    if(!t) return;
    var v = (t.value||'').toLowerCase();
    var map = { sales: 'salesFields', service: 'serviceFields', inquiry: 'inquiryFields' };
    ['salesFields','serviceFields','inquiryFields'].forEach(function(id){ var el=document.getElementById(id); if(el) el.style.display='none'; });
    var show = document.getElementById(map[v]); if(show) show.style.display='';
  }
  document.addEventListener('change', function(e){ if(e.target && e.target.id==='id_type'){ toggle(); }});
  document.addEventListener('DOMContentLoaded', function(){ toggle();
    var itemSel = document.getElementById('id_item_name');
    var brandHidden = document.getElementById('id_brand');
    var brandDisplay = document.getElementById('brandDisplay');
    function updateBrand(){
      if(!itemSel) return;
      var dataStr = itemSel.getAttribute('data-items') || '{}';
      try{ var data = JSON.parse(dataStr); }catch(e){ data = {}; }
      var opt = data[itemSel.value];
      var b = opt ? (opt.brand||'') : '';
      if(brandHidden){ brandHidden.value = b; }
      if(brandDisplay){ brandDisplay.textContent = b || 'â€”'; }
    }
    if(itemSel){ itemSel.addEventListener('change', updateBrand); updateBrand(); }
  });
})();
</script>
{% endblock %}