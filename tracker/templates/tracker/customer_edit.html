{% extends 'tracker/base.html' %}
{% load static %}
{% load date_filters %}
{% block title %}Edit Customer - {{ customer.full_name }}{% endblock %}

{% block content %}
<div class="page-body">
  <div class="container-fluid">
    <div class="page-title">
      <div class="row align-items-center">
        <div class="col-md-6">
          <h4>Edit Customer</h4>
          <p class="text-muted mb-0">{{ customer.full_name }} ({{ customer.code }})</p>
        </div>
        <div class="col-md-6">
          <ol class="breadcrumb justify-content-md-end mb-0">
            <li class="breadcrumb-item"><a href="{% url 'tracker:customers_list' %}">Customers</a></li>
            <li class="breadcrumb-item"><a href="{% url 'tracker:customer_detail' customer.pk %}">{{ customer.full_name }}</a></li>
            <li class="breadcrumb-item active">Edit</li>
          </ol>
        </div>
      </div>
    </div>
  </div>

  <div class="container-fluid">
    <form method="post" novalidate>
      {% csrf_token %}
      {% if messages %}
        {% for m in messages %}
          <div class="alert alert-{{ m.tags }} alert-dismissible fade show" role="alert">
            {{ m }}
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
          </div>
        {% endfor %}
      {% endif %}
      {% if form.non_field_errors %}
        <div class="alert alert-danger">{% for e in form.non_field_errors %}{{ e }}{% endfor %}</div>
      {% endif %}

      <div class="row g-3">
        <div class="col-lg-8">
          <div class="card shadow-sm">
            <div class="card-header bg-light"><h6 class="mb-0"><i class="fa fa-user me-2"></i>Basic Information</h6></div>
            <div class="card-body">
              <div class="row g-3">
                <div class="col-md-6">
                  <label class="form-label" for="id_full_name">Full name</label>
                  {{ form.full_name }}
                  <div class="invalid-feedback d-block">{{ form.full_name.errors|join:" " }}</div>
                </div>
                <div class="col-md-6">
                  <label class="form-label" for="id_phone">Phone</label>
                  {{ form.phone }}
                  <div class="invalid-feedback d-block">{{ form.phone.errors|join:" " }}</div>
                </div>
                <div class="col-md-6">
                  <label class="form-label" for="id_whatsapp">WhatsApp</label>
                  {{ form.whatsapp }}
                  <div class="invalid-feedback d-block">{{ form.whatsapp.errors|join:" " }}</div>
                </div>
                <div class="col-md-6">
                  <label class="form-label" for="id_email">Email</label>
                  {{ form.email }}
                  <div class="invalid-feedback d-block">{{ form.email.errors|join:" " }}</div>
                </div>
                <div class="col-12">
                  <label class="form-label" for="id_address">Address</label>
                  {{ form.address }}
                  <div class="invalid-feedback d-block">{{ form.address.errors|join:" " }}</div>
                </div>
                <div class="col-12">
                  <label class="form-label" for="id_notes">Notes</label>
                  {{ form.notes }}
                  <div class="invalid-feedback d-block">{{ form.notes.errors|join:" " }}</div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <div class="col-lg-4">
          <div class="card shadow-sm">
            <div class="card-header bg-light"><h6 class="mb-0"><i class="fa fa-id-card me-2"></i>Customer Type</h6></div>
            <div class="card-body">
              <div class="mb-3">
                <label class="form-label" for="id_customer_type">Type</label>
                {{ form.customer_type }}
                <div class="invalid-feedback d-block">{{ form.customer_type.errors|join:" " }}</div>
                <small class="text-muted d-block mt-1">Personal or Organization (Government/NGO/Company)</small>
              </div>
              <div id="personalFields" class="border rounded p-3 mb-3">
                <div class="mb-2 small text-muted">Personal details</div>
                <label class="form-label" for="id_personal_subtype">Personal subtype</label>
                {{ form.personal_subtype }}
                <div class="invalid-feedback d-block">{{ form.personal_subtype.errors|join:" " }}</div>
              </div>
              <div id="orgFields" class="border rounded p-3">
                <div class="mb-2 small text-muted">Organization details</div>
                <div class="mb-3">
                  <label class="form-label" for="id_organization_name">Organization name</label>
                  {{ form.organization_name }}
                  <div class="invalid-feedback d-block">{{ form.organization_name.errors|join:" " }}</div>
                </div>
                <div>
                  <label class="form-label" for="id_tax_number">Tax number/TIN</label>
                  {{ form.tax_number }}
                  <div class="invalid-feedback d-block">{{ form.tax_number.errors|join:" " }}</div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="mt-3 d-flex gap-2">
        <a class="btn btn-outline-secondary" href="{% url 'tracker:customer_detail' customer.pk %}"><i class="fa fa-arrow-left me-1"></i>Back</a>
        <button class="btn btn-primary" type="submit"><i class="fa fa-save me-1"></i>Save Changes</button>
      </div>
    </form>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
(function(){
  function toggleTypeFields(){
    var t = document.getElementById('id_customer_type');
    if(!t) return;
    var val = (t.value||'').toLowerCase();
    var personal = document.getElementById('personalFields');
    var org = document.getElementById('orgFields');
    if(val === 'personal'){
      if(personal) personal.style.display = '';
      if(org) org.style.display = 'none';
    } else if(['government','ngo','company'].indexOf(val) !== -1){
      if(personal) personal.style.display = 'none';
      if(org) org.style.display = '';
    } else {
      if(personal) personal.style.display = 'none';
      if(org) org.style.display = 'none';
    }
  }
  document.addEventListener('change', function(e){ if(e.target && e.target.id === 'id_customer_type'){ toggleTypeFields(); }});
  document.addEventListener('DOMContentLoaded', toggleTypeFields);
})();
</script>
{% endblock %}
